#!/usr/bin/env sh

unmute_all() {
    for i in $(pacmd list-sink-inputs | awk '/index: /{print $2}'); do
        pactl set-sink-input-mute "$i" false
    done
    exit
}

trap unmute_all INT TERM

mute_all() {
    for i in $(pacmd list-sink-inputs | awk '/index: /{print $2}'); do
        pactl set-sink-input-mute "$i" true
    done
}

while :
do
    focus_pid="$(xdotool getwindowfocus getwindowpid)"
    if [ "$unfocus_pid" != "$focus_pid" ]; then
        focus_index=$(pacmd list-sink-inputs | awk '/index:/{si = $2}; /'"$focus_pid"'/{print si; exit}')
        unfocus_index=$(pacmd list-sink-inputs | awk '/index:/{si = $2}; /'"$unfocus_pid"'/{print si; exit}')
        if [ "$focus_index" ]; then
            if [ "$unfocus_index" ]; then
                pactl set-sink-input-mute "$unfocus_index" true
            else
                mute_all
            fi
            pactl set-sink-input-mute "$focus_index" false
        fi
        unfocus_pid="$focus_pid"
    fi
    sleep 0.25
done
